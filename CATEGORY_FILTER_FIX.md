# Исправление фильтрации товаров по категориям

## Дата исправления
2025-01-15

## Проблема
При выборе основной категории с подкатегориями товары из самой основной категории не отображались - показывались только товары из подкатегорий.

## Ожидаемое поведение
1. **"Все категории"** - показывать все товары
2. **Выбор основной категории** - показывать товары из основной категории И из всех её подкатегорий
3. **Выбор подкатегории** - показывать только товары из этой подкатегории
4. **"Все подкатегории"** - показывать товары из всех подкатегорий (без основной категории)

## Исправления

### 1. `webapp/js/categories.js` - Выбор основной категории
**Проблема:** При выборе основной категории в `selectedCategoryIds` добавлялись только подкатегории, но не сама основная категория.

**Исправление:**
```javascript
// ДО:
if (mainCat.subcategories && mainCat.subcategories.length > 0) {
    selectedCategoryIds.clear();
    mainCat.subcategories.forEach(subCat => {
        selectedCategoryIds.add(subCat.id);
    });
}

// ПОСЛЕ:
selectedCategoryIds.clear();
// Добавляем саму основную категорию
selectedCategoryIds.add(mainCat.id);
// Если есть подкатегории, добавляем их тоже
if (mainCat.subcategories && mainCat.subcategories.length > 0) {
    mainCat.subcategories.forEach(subCat => {
        selectedCategoryIds.add(subCat.id);
    });
}
```

### 2. `webapp/js/categories.js` - Выбор подкатегории
**Проблема:** При выборе подкатегории ID основной категории оставался в `selectedCategoryIds`, что приводило к показу товаров из всей основной категории.

**Исправление:**
```javascript
option.onclick = () => {
    if (isSelected) {
        selectedCategoryIds.delete(subCat.id);
    } else {
        selectedCategoryIds.add(subCat.id);
    }
    // При выборе подкатегории удаляем ID основной категории
    // Чтобы показывались только товары из выбранных подкатегорий
    if (selectedMainCategoryId !== null && selectedCategoryIds.has(selectedMainCategoryId)) {
        selectedCategoryIds.delete(selectedMainCategoryId);
    }
    renderCategories(categoriesHierarchy);
    if (applyFiltersCallback) applyFiltersCallback();
};
```

### 3. `webapp/js/filters.js` - Улучшена логика фильтрации
**Исправление:** Упрощена и улучшена логика фильтрации с добавлением fallback для случаев, когда `selectedCategoryIds` пуст, но `selectedMainCategoryId` установлен.

## Результат
✅ При выборе основной категории показываются товары из неё И из всех подкатегорий
✅ При выборе подкатегории показываются только товары из этой подкатегории
✅ При выборе "Все категории" показываются все товары
✅ При выборе "Все подкатегории" показываются товары из всех подкатегорий

## Тестирование
1. ✅ Выбрать "Все категории" - должны показаться все товары
2. ✅ Выбрать основную категорию с подкатегориями - должны показаться товары из основной категории И из всех подкатегорий
3. ✅ Выбрать конкретную подкатегорию - должны показаться только товары из этой подкатегории
4. ✅ Выбрать "Все подкатегории" - должны показаться товары из всех подкатегорий (без основной категории)
