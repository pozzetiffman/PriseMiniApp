# Исправление рассинхронизации категорий между ботами

## Проблема

При синхронизации товаров между основным ботом и подключенными ботами возникает рассинхронизация `category_id`:

1. Товар создается в основном боте с `category_id=3`
2. Товар синхронизируется в подключенный бот, но категория еще не синхронизирована
3. Категория синхронизируется позже и получает `id=9` в подключенном боте
4. Товар все еще имеет старый `category_id=3` (из основного бота)
5. При фильтрации по категориям товары не отображаются, т.к. `category_id` не совпадает

## Решение

### 1. Скрипт для исправления рассинхронизации

Создан скрипт `backend/fix_category_sync.py` для исправления всех товаров с неправильным `category_id`.

#### Использование:

```bash
# Исправить для всех пользователей
cd backend
python fix_category_sync.py

# Исправить для конкретного пользователя
python fix_category_sync.py --user-id 123456789

# Проверить проблемы без исправления (dry-run)
python fix_category_sync.py --dry-run
```

#### Что делает скрипт:

1. Находит все товары пользователя
2. Для каждого товара проверяет, принадлежит ли его `category_id` тому же боту
3. Если нет - ищет категорию с таким же именем в боте товара
4. Обновляет `category_id` на правильный ID

### 2. Улучшенная логика синхронизации

Обновлена функция `sync_product_to_all_bots()` в `backend/app/utils/products_sync.py`:

- **Автоматическое создание категорий**: Если категория не найдена в целевом боте, она создается автоматически
- **Обновление category_id**: При обновлении товара всегда обновляется `category_id` на правильный ID категории в боте

### 3. Проверка при загрузке

В `webapp/js/data.js` добавлена проверка соответствия `category_id` товаров и категорий:

- При загрузке товаров и категорий проверяется, что все `category_id` товаров присутствуют в списке категорий
- Если обнаружено несоответствие, выводится предупреждение в консоль

## Как использовать

### Шаг 1: Проверка проблем

```bash
cd backend
python fix_category_sync.py --dry-run
```

Это покажет все проблемы без исправления.

### Шаг 2: Исправление

```bash
# Для всех пользователей
python fix_category_sync.py

# Или для конкретного пользователя
python fix_category_sync.py --user-id 123456789
```

### Шаг 3: Проверка результата

После исправления проверьте в логах:
- Количество исправленных товаров
- Количество ошибок (если категория не найдена в боте)

## Профилактика

Чтобы избежать рассинхронизации в будущем:

1. **Всегда синхронизируйте категории перед товарами**: При создании нового магазина сначала создайте все категории, затем товары
2. **Используйте улучшенную логику синхронизации**: Код автоматически создает категории, если они не найдены
3. **Периодически запускайте скрипт исправления**: Рекомендуется запускать раз в неделю или после массового создания товаров

## Логи

Скрипт выводит подробные логи:
- ✅ Успешно исправлено
- ⚠️ Пропущено (уже правильно)
- ❌ Ошибка (категория не найдена)

## Пример вывода

```
============================================================
Исправление рассинхронизации для user_id=123456789
============================================================

Найдено товаров: 10
✅ Товар 65 'Товар 1': category_id 3 -> 9 (бот 2)
✅ Товар 67 'Товар 2': category_id 30 -> 10 (бот 2)
⚠️ Товар 69 'Товар 3': category_id 32 -> 11 (бот 2)

============================================================
Результаты:
  Исправлено: 2
  Пропущено (уже правильно): 7
  Ошибок: 1
============================================================
```
